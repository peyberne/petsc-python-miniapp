name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: read

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    # Run inside your PETSc + petsc4py Docker image
    container:
      image: ghcr.io/peyberne/petsc-python-miniapp:cpu

    env:
      MPLBACKEND: Agg   # avoid GUI backend issues for matplotlib

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Python and PETSc info
        run: |
          python3 - << 'EOF'
          import sys
          from petsc4py import PETSc

          # Basic Python info
          print("Python:", sys.version)

          # PETSc/petsc4py info
          PETSc.Sys.Print("petsc4py imported OK.")
          # Try to get version info in a safe way
          if hasattr(PETSc.Sys, "getVersion"):
              ver = PETSc.Sys.getVersion()
              PETSc.Sys.Print("PETSc version (Sys.getVersion): %s" % (ver,))
          else:
              PETSc.Sys.Print("PETSc version helper not available in this build.")
          EOF

      - name: Run tiny smoke test (small in-memory system)
        run: |
          python3 - << 'EOF'
          from petsc4py import PETSc
          import benchmark_petsc

          # Build a tiny 2x2 system Ax = b
          A = PETSc.Mat().create(PETSc.COMM_WORLD)
          A.setSizes([[2, 2], [2, 2]])
          A.setType("aij")
          A.setUp()
          # A = [[4, 1],
          #      [1, 3]]
          A.setValue(0, 0, 4.0)
          A.setValue(0, 1, 1.0)
          A.setValue(1, 0, 1.0)
          A.setValue(1, 1, 3.0)
          A.assemblyBegin()
          A.assemblyEnd()

          b = PETSc.Vec().createSeq(2)
          b.setValues([0, 1], [1.0, 2.0])  # b = [1, 2]
          b.assemblyBegin()
          b.assemblyEnd()

          # No initial guess, no reference solution here
          def fake_load(*args, **kwargs):
              return A, b, None, None

          # Monkey-patch load_petsc_data to bypass binary files
          benchmark_petsc.load_petsc_data = fake_load

          # Call run_benchmarks with dummy filenames (unused) and CPU (use_gpu=False)
          results = benchmark_petsc.run_benchmarks(
              "mat.dat",
              "rhs.dat",
              guess_file=None,
              ref_file=None,
              use_gpu=False,
              config_file=None,
          )

          PETSc.Sys.Print("Smoke test finished, got %d result(s)." % (len(results),))
          EOF

      # Optional: run the full benchmark on your data
      - name: Run full benchmark on sample data
        run: |
          python3 benchmark_petsc.py \
            --mat data/mat.dat \
            --rhs data/rhs.dat \
            --guess data/guess.dat \
            --ref data/sol.dat \
            --config data/options.json
