name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    env:
      MPLBACKEND: Agg   # avoid GUI backend issues for matplotlib

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies (PETSc + petsc4py, MPI)
        run: |
          sudo apt-get update
          sudo apt-get install -y             python3-pip             python3-petsc4py             petsc-dev             libopenmpi-dev             openmpi-bin

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy matplotlib

      - name: Check that benchmark_petsc.py imports
        run: |
          python - << 'EOF'
          import benchmark_petsc
          from petsc4py import PETSc
          PETSc.Sys.Print("benchmark_petsc.py imported successfully in CI.")
          PETSc.Sys.Print("PETSc version: %s" % (PETSc.GetVersion(),))
          EOF

      - name: Run a tiny smoke test (small in-memory system)
        run: |
          python - << 'EOF'
          from petsc4py import PETSc
          import benchmark_petsc

          # Build a tiny 2x2 system Ax = b
          A = PETSc.Mat().create(PETSc.COMM_WORLD)
          A.setSizes([[2, 2], [2, 2]])
          A.setType("aij")
          A.setUp()
          # A = [[4, 1],
          #      [1, 3]]
          A.setValue(0, 0, 4.0)
          A.setValue(0, 1, 1.0)
          A.setValue(1, 0, 1.0)
          A.setValue(1, 1, 3.0)
          A.assemblyBegin()
          A.assemblyEnd()

          b = PETSc.Vec().createSeq(2)
          b.setValues([0, 1], [1.0, 2.0])  # b = [1, 2]
          b.assemblyBegin()
          b.assemblyEnd()

          # No initial guess, no reference solution here
          def fake_load(*args, **kwargs):
              return A, b, None, None

          # Monkey-patch load_petsc_data to bypass binary files
          benchmark_petsc.load_petsc_data = fake_load

          # Call run_benchmarks with dummy filenames (unused) and CPU (use_gpu=False)
          results = benchmark_petsc.run_benchmarks(
              "mat.dat",
              "rhs.dat",
              guess_file=None,
              ref_file=None,
              use_gpu=False,
              config_file=None,
          )

          PETSc.Sys.Print("Smoke test finished, got %d result(s)." % (len(results),))
          EOF
